<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Qu·∫£n l√Ω c√¥ng n·ª£ - POS & Inventory</title>
    <link rel="stylesheet" href="../style/QuanLyCongNo.css">
  </head>
  <body>
    <div class="wrap">
      <aside class="sidebar">
        <div class="brand">
          <div class="logo">DAH</div>
          <div><div>Qu·∫£n l√Ω b√°n l·∫ª v√† kho DAH</div></div>
        </div>

        <div class="nav">
          <div class="section-title">K·∫ø to√°n</div>
          <a href="../pages/QuanLyConNo.html">üßæ Qu·∫£n l√Ω c√¥ng n·ª£</a>
          <a href="../pages/BaoCaoThongKe.html">üìä B√°o c√°o th·ªëng k√™</a>

          <div class="section-title">T√†i kho·∫£n</div>
          <div class="quick-stats">
            <div class="row" style="justify-content:space-between"><span>Ng∆∞·ªùi d√πng:</span><strong>DAH</strong></div>
          </div>
        </div>

        <div class="small muted">¬© DAH</div>
      </aside>

      <main class="main">
        <div class="header">
          <div>
            <div class="breadcrumbs">K·∫ø to√°n / Qu·∫£n l√Ω c√¥ng n·ª£</div>
            <h1 style="margin:6px 0 0 0">Qu·∫£n l√Ω c√¥ng n·ª£</h1>
          </div>
        </div>

        <section class="card" aria-label="Danh s√°ch c√¥ng n·ª£ kh√°ch h√†ng">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
            <h2 style="margin:0">Kh√°ch h√†ng c√≤n n·ª£</h2>
          </div>

          <table class="debt-table" id="debt-table">
            <thead>
              <tr>
                <th>Kh√°ch h√†ng</th>
                <th>S·ªë h√≥a ƒë∆°n</th>
                <th>T·ªïng n·ª£ (‚Ç´)</th>
                <th>C√≤n n·ª£ (‚Ç´)</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div id="detail-area"></div>
        </section>
      </main>
    </div>

    <script>
      const db = {
        HoaDonBan: [
          { id: 'HD001', ngay: '2025-10-01', khach: 'Nguy·ªÖn A', tong: 1500000, paid: 500000 },
          { id: 'HD002', ngay: '2025-10-05', khach: 'ƒê·ªó B', tong: 3200000, paid: 3200000 },
          { id: 'HD003', ngay: '2025-10-15', khach: 'Nguy·ªÖn A', tong: 700000, paid: 0 },
          { id: 'HD004', ngay: '2025-10-20', khach: 'Ph·∫°m C', tong: 1200000, paid: 200000 }
        ],
        ThanhToan: [
          { id: 'TT001', hoaDonId: 'HD001', ngay: '2025-10-02', soTien: 500000, method: 'Ti·ªÅn m·∫∑t' },
          { id: 'TT002', hoaDonId: 'HD002', ngay: '2025-10-06', soTien: 3200000, method: 'Chuy·ªÉn kho·∫£n' }
        ]
      };

      const money = n => new Intl.NumberFormat('vi-VN').format(n || 0);

      function groupDebts() {
        const map = {};
        db.HoaDonBan.forEach(h => {
          const owe = Math.max(0, (h.tong || 0) - (h.paid || 0));
          if (!map[h.khach]) map[h.khach] = { khach: h.khach, invoices: [], total: 0, owed: 0 };
          map[h.khach].invoices.push(Object.assign({}, h, { owed: owe }));
          map[h.khach].total += (h.tong || 0);
          map[h.khach].owed += owe;
        });
        return Object.values(map).sort((a,b)=>b.owed - a.owed);
      }

      function renderDebts() {
        const tbody = document.querySelector('#debt-table tbody');
        const list = groupDebts();
        if (!list.length) {
          tbody.innerHTML = '<tr><td colspan="5" class="muted">Kh√¥ng c√≥ kh√°ch h√†ng c√≤n n·ª£.</td></tr>';
          return;
        }
        tbody.innerHTML = '';
        list.forEach((c) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.khach}</td>
            <td>${c.invoices.length}</td>
            <td>${money(c.total)}</td>
            <td>${money(c.owed)}</td>
            <td class="inline">
              <button class="btn ghost" data-act="view" data-k="${c.khach}">Xem h√≥a ƒë∆°n</button>
              ${c.owed > 0 ? `<button class="btn primary" data-act="pay" data-k="${c.khach}">Thanh to√°n</button>` : `<span class="small muted">ƒê√£ thu s·∫°ch</span>`}
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      function renderInvoicesFor(khach) {
        const invoices = db.HoaDonBan.filter(h => h.khach === khach);
        if (!invoices.length) {
          document.getElementById('detail-area').innerHTML = '<div class="muted">Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n.</div>';
          return;
        }
        let html = `<div class="invoices"><h3 style="margin:8px 0 6px 0">H√≥a ƒë∆°n c·ªßa ${khach}</h3><table class="debt-table"><thead><tr><th>ID</th><th>Ng√†y</th><th>T·ªïng (‚Ç´)</th><th>ƒê√£ tr·∫£ (‚Ç´)</th><th>C√≤n l·∫°i (‚Ç´)</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody>`;
        invoices.forEach(h => {
          const owed = Math.max(0, (h.tong||0) - (h.paid||0));
          html += `<tr>
            <td>${h.id}</td>
            <td>${h.ngay}</td>
            <td>${money(h.tong)}</td>
            <td>${money(h.paid || 0)}</td>
            <td class="${owed ? 'unpaid' : 'paid'}">${money(owed)}</td>
            <td>
              ${owed > 0 
                ? `<button class="btn primary" data-pay="${h.id}">Thanh to√°n</button>`
                : `<span class="small muted">ƒê√£ thanh to√°n</span>
                   <button class="btn ghost" data-del="${h.id}" style="margin-left:6px;">X√≥a</button>`}
            </td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
        document.getElementById('detail-area').innerHTML = html;

        document.querySelectorAll('[data-pay]').forEach(b=>{
          b.addEventListener('click', () => payInvoice(b.getAttribute('data-pay')));
        });
        document.querySelectorAll('[data-del]').forEach(b=>{
          b.addEventListener('click', () => deleteInvoice(b.getAttribute('data-del')));
        });
      }

      function payInvoice(invoiceId) {
        const inv = db.HoaDonBan.find(h => h.id === invoiceId);
        if (!inv) return alert('H√≥a ƒë∆°n kh√¥ng t√¨m th·∫•y');
        const owed = Math.max(0, (inv.tong||0) - (inv.paid||0));
        const str = prompt(`H√≥a ƒë∆°n ${inv.id} c√≤n ${money(owed)}. Nh·∫≠p s·ªë ti·ªÅn thanh to√°n (b·ªè tr·ªëng = to√†n b·ªô):`);
        if (str === null) return;
        let amt = Number(String(str).replace(/[^\d.-]/g,'')) || 0;
        if (amt <= 0) amt = owed;
        if (amt > owed) amt = owed;
        const method = prompt('Ph∆∞∆°ng th·ª©c thanh to√°n (Ti·ªÅn m·∫∑t / Chuy·ªÉn kho·∫£n / Th·∫ª):', 'Ti·ªÅn m·∫∑t') || 'Ti·ªÅn m·∫∑t';
        const ttId = 'TT' + Math.floor(Math.random()*900000 + 100000);
        db.ThanhToan.push({ id: ttId, hoaDonId: inv.id, ngay: new Date().toISOString().slice(0,10), soTien: amt, method });
        inv.paid = (inv.paid || 0) + amt;
        if (inv.paid > inv.tong) inv.paid = inv.tong;
        alert(`Thanh to√°n ${money(amt)} cho ${inv.id} th√†nh c√¥ng.`);
        renderDebts();
        renderInvoicesFor(inv.khach);
        document.getElementById('detail-area').scrollIntoView({behavior:'smooth'});
      }

      function deleteInvoice(invoiceId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h√≥a ƒë∆°n n√†y kh√¥ng?')) return;
        const idx = db.HoaDonBan.findIndex(h => h.id === invoiceId);
        if (idx === -1) return alert('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n c·∫ßn x√≥a.');
        const kh = db.HoaDonBan[idx].khach;
        db.HoaDonBan.splice(idx, 1);
        alert('ƒê√£ x√≥a h√≥a ƒë∆°n ' + invoiceId);
        renderDebts();
        renderInvoicesFor(kh);
      }

      document.addEventListener('DOMContentLoaded', () => {
        renderDebts();
        document.getElementById('debt-table').addEventListener('click', e => {
          const v = e.target;
          if (v.matches('[data-act="view"]')) {
            renderInvoicesFor(v.getAttribute('data-k'));
            document.getElementById('detail-area').scrollIntoView({behavior:'smooth'});
          } else if (v.matches('[data-act="pay"]')) {
            renderInvoicesFor(v.getAttribute('data-k'));
            document.getElementById('detail-area').scrollIntoView({behavior:'smooth'});
          }
        });
      });
    </script>
  </body>
</html>