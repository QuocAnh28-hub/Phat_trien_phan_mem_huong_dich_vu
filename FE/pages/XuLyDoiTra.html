<!DOCTYPE html>
<html lang="vi" ng-app="DAHApp">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DAH ‚Äî X·ª≠ l√Ω ƒê·ªïi/Tr·∫£</title>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <script src="../angular/angular.min.js"></script>
  <script src="../script/login.js"></script>
  <script src="../script/auth.js"></script>
  <link rel="stylesheet" href="../style/XuLyDoiTra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
  <script defer src="../script/XuLyDoiTra.js"></script>
</head>

<body ng-controller="XuLyDoiTraCtrl as vm">
  <div class="warp">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">DAH</div>
        <div><div>Qu·∫£n l√Ω b√°n l·∫ª v√† kho DAH</div></div>
      </div>

      <nav class="nav">
        <div class="section-title">ADMIN</div>
        <a href="QuanLyTaiKhoan.html">üõ†Ô∏è Qu·∫£n l√Ω t√†i kho·∫£n</a>
        <a href="QuanLyNhanVien.html">üßë‚Äçüíº Qu·∫£n l√Ω nh√¢n vi√™n</a>
        <a href="QuanLyKhuyenMai.html">üéÅ Qu·∫£n l√Ω khuy·∫øn m√£i</a>

        <div class="section-title" style="margin-top:20px;font-weight:700;">K·∫ø to√°n</div>
        <a href="../pages/QuanLyCongNo.html">üßæ Qu·∫£n l√Ω c√¥ng n·ª£</a>
        <a href="../pages/BaoCaoThongKe.html">üìä B√°o c√°o th·ªëng k√™</a>

        <div class="section-title">THU NG√ÇN</div>
        <a href="QuanLyBanHang.html">üßæ QU·∫¢N L√ù B√ÅN H√ÄNG</a>
        <a href="XuLyDoiTra.html" class="active">üîÅ X·ª¨ L√ù ƒê·ªîI TR·∫¢</a>

        <div class="section-title" style="margin-top:20px;font-weight:700;">Th·ªß kho</div>
        <a href="QuanLyDanhMuc.html">üì¶ Qu·∫£n l√Ω Danh m·ª•c</a>
        <a href="QuanLySanPham.html">üì¶ Qu·∫£n l√Ω S·∫£n ph·∫©m</a>
        <a href="QuanLyNhapKho.html">üì¶ Qu·∫£n l√Ω Nh·∫≠p kho</a>
        <a href="QuanLyTonKho.html">üì¶ Qu·∫£n l√Ω T·ªìn kho</a>
      </nav>

      <div class="section-title">T√†i kho·∫£n</div>
      <div class="quick-stats">
        <div class="row" style="justify-content:space-between">
          <span>Ng∆∞·ªùi d√πng:</span><strong>{{ vm.currentUser }}</strong>
        </div>
      </div>
      <div class="small muted">¬© DAH</div>
      <div class="logout">
        <a href="index.html">ƒêƒÉng xu·∫•t <i class="fa-solid fa-right-from-bracket"></i></a>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="header">
        <div>
          <div class="breadcrumbs">THU NG√ÇN / X·ª≠ l√Ω ƒë·ªïi tr·∫£</div>
          <h1 class="h1">X·ª¨ L√ù ƒê·ªîI / TR·∫¢</h1>
        </div>
        <div class="actions"><div class="pill">Ng√¥n ng·ªØ: VN</div></div>
      </div>

      <!-- 1) T√¨m h√≥a ƒë∆°n g·ªëc -->
      <section class="card">
        <h3 class="h3">T√¨m h√≥a ƒë∆°n g·ªëc</h3>
        <div class="row" style="gap:12px;flex-wrap:wrap;align-items:flex-end">
          <div>
            <div class="small muted">M√£ h√≥a ƒë∆°n</div>
            <input class="input" placeholder="vd: HD001" ng-model="vm.search.maHD">
          </div>
          <div>
            <div class="small muted">Ng√†y b√°n t·ª´</div>
            <input type="date" class="input" ng-model="vm.search.from">
          </div>
          <div>
            <div class="small muted">ƒë·∫øn</div>
            <input type="date" class="input" ng-model="vm.search.to">
          </div>
          <div class="row" style="gap:8px">
            <a class="btn" href="" ng-click="vm.fetchInvoice($event)">T·∫£i h√≥a ƒë∆°n</a>
            <a class="btn secondary" href="" ng-click="vm.resetAll($event)">L√†m m·ªõi</a>
          </div>
        </div>
      </section>

      <!-- 2) Th√¥ng tin h√≥a ƒë∆°n g·ªëc -->
      <section class="card" ng-if="vm.invoice">
        <div class="row" style="gap:16px;flex-wrap:wrap">
          <div style="min-width:220px">
            <div class="small muted">M√£ Hƒê</div>
            <strong>{{ vm.invoice.id || '‚Äî' }}</strong>
          </div>
          <div style="min-width:220px">
            <div class="small muted">Kh√°ch h√†ng</div>
            <strong>{{ vm.invoice.customerId || '‚Äî' }}</strong>
          </div>
          <div style="min-width:220px">
            <div class="small muted">Ng√†y l·∫≠p</div>
            <strong>{{ vm.invoice.createdAt | date:'dd/MM/yyyy HH:mm' }}</strong>
          </div>
          <div style="min-width:220px">
            <div class="small muted">T·ªïng ti·ªÅn h√†ng</div>
            <strong>{{ vm.invoice.goodsTotal | currency:'':0 }} ‚Ç´</strong>
          </div>
        </div>
      </section>

      <!-- 3) Ch·ªçn h√†ng ƒë·ªÉ ƒë·ªïi/tr·∫£ -->
      <section class="card" ng-if="vm.details.length">
        <h3 class="h3">Ch·ªçn h√†ng ƒë·ªÉ ƒë·ªïi / tr·∫£</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Ch·ªçn</th>
                <th>M√É SP</th>
                <th>T√äN S·∫¢N PH·∫®M</th>
                <th>SL ƒë√£ mua</th>
                <th>SL ƒë·ªïi/tr·∫£</th>
                <th>ƒê∆°n gi√°</th>
                <th>L√Ω do</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="it in vm.details">
                <td>
                  <input type="checkbox"
                         ng-checked="vm.retQty[it.productId] > 0"
                         ng-click="vm.toggleReturn(it.productId)">
                </td>
                <td>{{ it.productId }}</td>
                <td>{{ it.productName || it.productId }}</td>
                <td>{{ it.qty }}</td>
                <td>
                  <input class="input" style="width:80px" type="number" min="0" max="{{it.qty}}"
                         ng-model="vm.retQty[it.productId]"
                         ng-change="vm.onQtyChange(it.productId, it.qty)">
                </td>
                <td>{{ it.price | currency:'':0 }} ‚Ç´</td>
                <td>
                  <select class="input" ng-model="vm.retReason[it.productId]">
                    <option>Kh√¥ng ∆∞ng</option>
                    <option>L·ªói/ h·ªèng</option>
                    <option>Giao nh·∫ßm</option>
                  </select>
                </td>
              </tr>
              <tr ng-if="!vm.details.length">
                <td colspan="7" style="text-align:center">Kh√¥ng c√≥ s·∫£n ph·∫©m</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- H√†ng ƒë·ªïi -->
        <div class="row" style="margin-top:12px;gap:8px">
          <span class="small muted">Th√™m s·∫£n ph·∫©m ƒë·ªïi:</span>
          <input class="input" placeholder="M√£/T√™n SP" ng-model="vm.newEx.code">
          <input class="input" placeholder="SL" style="width:80px" ng-model="vm.newEx.qty" type="number" min="1">
          <input class="input" placeholder="Gi√°" style="width:120px" ng-model="vm.newEx.price" type="number" min="0">
          <a class="btn secondary" href="" ng-click="vm.addExchange($event)">Th√™m v√†o danh s√°ch ƒë·ªïi</a>
        </div>

        <div class="table-wrap" style="margin-top:8px" ng-if="vm.exchangeItems.length">
          <table>
            <thead>
              <tr><th>M√É/T√äN</th><th>SL</th><th>ƒê∆°n gi√°</th><th>Th√†nh ti·ªÅn</th><th></th></tr>
            </thead>
            <tbody>
              <tr ng-repeat="x in vm.exchangeItems">
                <td>{{ x.code }}</td>
                <td>{{ x.qty }}</td>
                <td>{{ x.price | currency:'':0 }} ‚Ç´</td>
                <td>{{ (x.qty * x.price) | currency:'':0 }} ‚Ç´</td>
                <td><button class="icon-btn delete" title="X√≥a" ng-click="vm.removeExchange($index)"><i class="fa-solid fa-trash"></i></button></td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- 4) T·ªïng k·∫øt -->
      <section class="card" ng-if="vm.invoice">
        <h3 class="h3">T·ªïng k·∫øt</h3>
        <div class="row" style="gap:24px;flex-wrap:wrap">
          <div style="min-width:240px">
            <div class="small muted">Gi√° tr·ªã h√†ng tr·∫£</div>
            <strong id="sumReturn">{{ vm.sumReturn | currency:'':0 }} ‚Ç´</strong>
          </div>
          <div style="min-width:240px">
            <div class="small muted">Gi√° tr·ªã h√†ng ƒë·ªïi</div>
            <strong id="sumExchange">{{ vm.sumExchange | currency:'':0 }} ‚Ç´</strong>
          </div>
          <div style="min-width:340px">
            <div class="small muted">Ch√™nh l·ªách (√¢m: ho√†n, d∆∞∆°ng: thu th√™m)</div>
            <strong id="sumDiff" ng-class="{'tag-return': vm.sumDiff < 0, 'tag-exchange': vm.sumDiff >= 0}">
              {{ vm.sumDiff | currency:'':0 }} ‚Ç´
            </strong>
          </div>
        </div>

        <div class="row" style="gap:12px;flex-wrap:wrap;margin-top:12px">
          <div>
            <div class="small muted">H√¨nh th·ª©c ho√†n/thu</div>
            <select class="input" style="min-width:200px" ng-model="vm.paymentMethod">
              <option>Ti·ªÅn m·∫∑t</option>
              <option>Chuy·ªÉn kho·∫£n</option>
              <option>Th·∫ª</option>
            </select>
          </div>
          <div style="flex:1;min-width:260px">
            <div class="small muted">Ghi ch√∫</div>
            <input class="input" placeholder="L√Ω do chi ti·∫øt..." ng-model="vm.note">
          </div>
          <div class="row" style="gap:8px; margin-left:auto">
            <a class="btn secondary" href="" ng-click="vm.resetAll($event)">H·ªßy</a>
            <a class="btn" href="" ng-click="vm.createVoucher($event)">T·∫°o phi·∫øu ƒë·ªïi/tr·∫£</a>
          </div>
        </div>
      </section>

      <!-- 5) H√≥a ƒë∆°n g·∫ßn ƒë√¢y -->
      <section class="card">
        <h3 class="h3">ƒê∆°n b√°n g·∫ßn ƒë√¢y</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>M√É Hƒê</th><th>KH√ÅCH H√ÄNG</th><th>NG√ÄY</th><th>T·ªîNG TI·ªÄN H√ÄNG</th></tr>
            </thead>
            <tbody>
              <tr ng-repeat="inv in vm.history" ng-click="vm.pickHistory(inv)" style="cursor:pointer">
                <td>{{ (inv.maHoaDon || inv.mahdban || inv.mahdBan || inv.id) }}</td>
                <td>{{ inv.maKH || inv.makh }}</td>
                <td>{{ (inv.ngayLap || inv.ngaylap) | date:'dd/MM/yyyy HH:mm' }}</td>
                <td>{{ (inv.tongTienHang || inv.tongtienhang) | currency:'':0 }} ‚Ç´</td>
              </tr>
              <tr ng-if="!vm.history.length">
                <td colspan="4" style="text-align:center">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>
</body>
</html>
