<!DOCTYPE html>
<html lang="vi" ng-app="DAHApp">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DAH ‚Äî X·ª≠ l√Ω ƒê·ªïi/Tr·∫£</title>
<<<<<<< HEAD

  <!-- AngularJS -->
  <script src="../angular/angular.min.js"></script>


  <!-- UI -->
  <link rel="stylesheet" href="../style/XuLyDoiTra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
  <!-- Optional -->
  <script src="../script/login.js"></script>
  <script src="../script/auth.js"></script>

  <!-- App -->
=======
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <script src="../angular/angular.min.js"></script>
  <script src="../script/login.js"></script>
  <script src="../script/auth.js"></script>
  <link rel="stylesheet" href="../style/XuLyDoiTra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
>>>>>>> main
  <script defer src="../script/XuLyDoiTra.js"></script>
</head>

<body ng-controller="XuLyDoiTraCtrl as vm">
  <div class="warp">
<<<<<<< HEAD
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="Thanh ƒëi·ªÅu h∆∞·ªõng">
=======
    <aside class="sidebar">
>>>>>>> main
      <div class="brand">
        <div class="logo" aria-hidden="true">DAH</div>
        <div><div>Qu·∫£n l√Ω b√°n l·∫ª v√† kho DAH</div></div>
      </div>

      <nav class="nav">
        <div class="section-title">ADMIN</div>
        <a href="QuanLyTaiKhoan.html">üõ†Ô∏è Qu·∫£n l√Ω t√†i kho·∫£n</a>
        <a href="QuanLyNhanVien.html">üßë‚Äçüíº Qu·∫£n l√Ω nh√¢n vi√™n</a>
        <a href="QuanLyKhuyenMai.html">üéÅ Qu·∫£n l√Ω khuy·∫øn m√£i</a>

        <div class="section-title" style="margin-top:20px;font-weight:700;">K·∫ø to√°n</div>
        <a href="../pages/QuanLyCongNo.html">üßæ Qu·∫£n l√Ω c√¥ng n·ª£</a>
        <a href="../pages/BaoCaoThongKe.html">üìä B√°o c√°o th·ªëng k√™</a>

        <div class="section-title">THU NG√ÇN</div>
        <a href="QuanLyBanHang.html">üßæ QU·∫¢N L√ù B√ÅN H√ÄNG</a>
        <a href="XuLyDoiTra.html" class="active" aria-current="page">üîÅ X·ª¨ L√ù ƒê·ªîI TR·∫¢</a>

        <div class="section-title" style="margin-top:20px;font-weight:700;">Th·ªß kho</div>
        <a href="QuanLyDanhMuc.html">üì¶ Qu·∫£n l√Ω Danh m·ª•c</a>
        <a href="QuanLySanPham.html">üì¶ Qu·∫£n l√Ω S·∫£n ph·∫©m</a>
        <a href="QuanLyNhapKho.html">üì¶ Qu·∫£n l√Ω Nh·∫≠p kho</a>
        <a href="QuanLyTonKho.html">üì¶ Qu·∫£n l√Ω T·ªìn kho</a>
      </nav>

      <div class="section-title">T√†i kho·∫£n</div>
      <div class="quick-stats">
        <div class="row" style="justify-content:space-between">
          <span>Ng∆∞·ªùi d√πng:</span><strong>{{ vm.currentUser }}</strong>
        </div>
      </div>
      <div class="logout">
        <a href="index.html">ƒêƒÉng xu·∫•t <i class="fa-solid fa-right-from-bracket"></i></a>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="header">
        <div>
          <p class="breadcrumbs">THU NG√ÇN / X·ª≠ l√Ω ƒë·ªïi tr·∫£</p>
          <h1 class="h1">X·ª¨ L√ù ƒê·ªîI / TR·∫¢</h1>
        </div>
        <div class="actions"><div class="small" aria-label="Ng√¥n ng·ªØ hi·ªán t·∫°i">Ng√¥n ng·ªØ: VN</div></div>
      </header>

      <!-- 1) T√¨m h√≥a ƒë∆°n g·ªëc -->
      <section class="card" aria-labelledby="searchTitle">
        <h3 id="searchTitle" class="h3">T√¨m h√≥a ƒë∆°n g·ªëc</h3>
        <form class="row" style="gap:12px;align-items:flex-end" ng-submit="vm.fetchInvoice()">
          <label>
            <div class="small">M√£ h√≥a ƒë∆°n</div>
            <input class="input" placeholder="vd: HD001" ng-model="vm.search.maHD" autocomplete="off" />
          </label>
          <label>
            <div class="small">Ng√†y b√°n t·ª´</div>
            <input type="date" class="input" ng-model="vm.search.from" />
          </label>
          <label>
            <div class="small">ƒë·∫øn</div>
            <input type="date" class="input" ng-model="vm.search.to" />
          </label>
          <div class="row" style="gap:8px">
            <button class="btn" type="submit" ng-disabled="vm.loading">
              <i class="fa-solid fa-download"></i> T·∫£i h√≥a ƒë∆°n
            </button>
            <button class="btn secondary" type="button" ng-click="vm.resetAll()" ng-disabled="vm.loading">
              L√†m m·ªõi
            </button>
          </div>
        </form>
      </section>

      <!-- 2) Th√¥ng tin h√≥a ƒë∆°n g·ªëc -->
      <section class="card" ng-if="vm.invoice" aria-labelledby="infoTitle">
        <h3 id="infoTitle" class="h3">Th√¥ng tin h√≥a ƒë∆°n g·ªëc</h3>
        <div class="row" style="gap:16px">
          <div style="min-width:220px">
            <div class="small">M√£ Hƒê</div>
            <strong>{{ vm.invoice.id || '‚Äî' }}</strong>
          </div>
          <div style="min-width:220px">
            <div class="small">Kh√°ch h√†ng</div>
            <strong>{{ vm.invoice.customerId || '‚Äî' }}</strong>
          </div>
          <div style="min-width:220px">
            <div class="small">Ng√†y l·∫≠p</div>
            <strong>{{ vm.invoice.createdAt | date:'dd/MM/yyyy HH:mm' }}</strong>
          </div>
          <div style="min-width:220px">
            <div class="small">T·ªïng ti·ªÅn h√†ng</div>
            <strong>{{ vm.invoice.goodsTotal | currency:'':0 }} ‚Ç´</strong>
          </div>
        </div>
      </section>

      <!-- 3) Ch·ªçn h√†ng ƒë·ªÉ ƒë·ªïi/tr·∫£ -->
      <section class="card" ng-if="vm.invoice" aria-labelledby="chooseTitle">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 id="chooseTitle" class="h3">Ch·ªçn h√†ng ƒë·ªÉ ƒë·ªïi / tr·∫£</h3>
        </div>

        <div class="table-wrap" role="region" aria-label="Danh s√°ch chi ti·∫øt h√≥a ƒë∆°n">
          <table>
            <caption class="small" style="text-align:left;padding:4px 0">Chi ti·∫øt c√°c m·∫∑t h√†ng ƒë√£ mua</caption>
            <thead>
              <tr>
                <th scope="col">Ch·ªçn</th>
                <th scope="col">M√É SP</th>
                <th scope="col">T√äN S·∫¢N PH·∫®M</th>
                <th scope="col">SL ƒë√£ mua</th>
                <th scope="col">SL ƒë·ªïi/tr·∫£</th>
                <th scope="col">ƒê∆°n gi√°</th>
                <th scope="col">L√Ω do</th>
                <th scope="col" aria-label="Thao t√°c"></th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="it in vm.details track by it.productId">
                <td>
                  <input type="checkbox"
                         aria-label="Ch·ªçn {{it.productId}}"
                         ng-checked="vm.retQty[it.productId] > 0"
                         ng-click="vm.toggleReturn(it.productId, it.qty)">
                </td>
                <td>{{ it.productId }}</td>
                <td>{{ it.productName || it.productId }}</td>
                <td>{{ it.qty }}</td>
                <td>
                  <input class="input" style="width:80px" type="number" min="0" max="{{it.qty}}"
                         ng-model="vm.retQty[it.productId]"
                         ng-change="vm.onQtyChange(it.productId, it.qty)">
                </td>
                <td>{{ it.price | currency:'':0 }} ‚Ç´</td>
                <td>
                  <select class="input" ng-model="vm.retReason[it.productId]" aria-label="L√Ω do {{it.productId}}">
                    <option>Kh√¥ng ∆∞ng</option>
                    <option>L·ªói/ h·ªèng</option>
                    <option>Giao nh·∫ßm</option>
                  </select>
                </td>
                <td class="table-actions">

                </td>
              </tr>
              <tr ng-if="!vm.details.length">
                <td colspan="8" style="text-align:center">Kh√¥ng c√≥ s·∫£n ph·∫©m</td>
              </tr>
            </tbody>
          </table>
        </div>


        <div class="table-wrap" style="margin-top:8px" ng-if="vm.exchangeItems.length">
          <table aria-label="Danh s√°ch h√†ng ƒë·ªïi">
            <thead>
              <tr>
                <th scope="col">M√É/T√äN</th>
                <th scope="col">SL</th>
                <th scope="col">ƒê∆°n gi√°</th>
                <th scope="col">Th√†nh ti·ªÅn</th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="x in vm.exchangeItems track by $index">
                <td>{{ x.code }}</td>
                <td>{{ x.qty }}</td>
                <td>{{ x.price | currency:'':0 }} ‚Ç´</td>
                <td>{{ (x.qty * x.price) | currency:'':0 }} ‚Ç´</td>
                <td>
                  <button class="icon-btn delete" type="button" title="X√≥a" ng-click="vm.removeExchange($index)" ng-disabled="vm.loading">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- 4) T·ªïng k·∫øt -->
      <section class="card" ng-if="vm.invoice" aria-labelledby="sumTitle">
        <h3 id="sumTitle" class="h3">T·ªïng k·∫øt</h3>
        <div class="row" style="gap:24px">
          <div style="min-width:240px">
            <div class="small">Gi√° tr·ªã h√†ng tr·∫£</div>
            <strong id="sumReturn">{{ vm.sumReturn | currency:'':0 }} ‚Ç´</strong>
          </div>
          <div style="min-width:240px">
            <div class="small">Gi√° tr·ªã h√†ng ƒë·ªïi</div>
            <strong id="sumExchange">{{ vm.sumExchange | currency:'':0 }} ‚Ç´</strong>
          </div>
          <div style="min-width:340px">
            <div class="small">Ch√™nh l·ªách (√¢m: ho√†n, d∆∞∆°ng: thu th√™m)</div>
            <strong id="sumDiff" ng-class="{'tag-return': vm.sumDiff < 0, 'tag-exchange': vm.sumDiff >= 0}">
              {{ vm.sumDiff | currency:'':0 }} ‚Ç´
            </strong>
          </div>
        </div>

        <div class="row" style="gap:12px; margin-top:12px; align-items:flex-end">
          <label>
            <div class="small">H√¨nh th·ª©c ho√†n/thu</div>
            <select class="input" style="min-width:200px" ng-model="vm.paymentMethod">
              <option>Ti·ªÅn m·∫∑t</option>
              <option>Chuy·ªÉn kho·∫£n</option>
              <option>Th·∫ª</option>
            </select>
          </label>
          <label style="flex:1;min-width:260px">
            <div class="small">Ghi ch√∫</div>
            <input class="input" placeholder="L√Ω do chi ti·∫øt..." ng-model="vm.note">
          </label>
          <div class="row" style="gap:8px; margin-left:auto">
            <button class="btn secondary" type="button" ng-click="vm.resetAll()" ng-disabled="vm.loading">H·ªßy</button>
            <button class="btn" type="button" ng-click="vm.createVoucher($event)" ng-disabled="vm.loading">X√°c Nh·∫≠n ƒê·ªïi Tr·∫£</button>
          </div>
        </div>
      </section>


      <!-- 6) Thanh to√°n -->
<section class="card" ng-if="vm.invoice" aria-labelledby="payTitle">

  <div class="table-wrap">
    <table aria-label="Danh s√°ch thanh to√°n">
      <thead>
        <tr>
          <th scope="col">M√É TT</th>
          <th scope="col">M√É Hƒê</th>
          <th scope="col">S·ªë ti·ªÅn</th>
          <th scope="col">Ph∆∞∆°ng th·ª©c</th>
          <th scope="col">Ng√†y thanh to√°n</th>
          <th scope="col">Tr·∫°ng th√°i</th>
        </tr>
      </thead>
<tbody>
  <tr ng-repeat="p in vm.payments track by p.id">
    <!-- M√É TT -->
    <td>{{ p.id }}</td>

    <!-- M√É Hƒê -->
    <td>{{ p.maHoaDon }}</td>

    <!-- S·ªê TI·ªÄN -->
    <td>{{ p.soTien | currency:'':0 }} ‚Ç´</td>

    <!-- PH∆Ø∆†NG TH·ª®C -->
    <td>{{ p.phuongThuc }}</td>

    <!-- NG√ÄY THANH TO√ÅN -->
    <td>{{ p.ngayThanhToan | date:'dd/MM/yyyy' }}</td>

    <!-- TR·∫†NG TH√ÅI -->
    <td>{{ p.trangThai }}</td>
  </tr>

  <tr ng-if="!vm.payments.length">
    <td colspan="6" style="text-align:center">Ch∆∞a c√≥ thanh to√°n</td>
  </tr>
</tbody>


    </table>
  </div>
</section>

    </main>
  </div>

  <!-- MODAL: S·ª≠a h√≥a ƒë∆°n -->
  <div class="modal-backdrop" ng-if="vm.modal.editInvoice.show" ng-click="vm.closeModals()" aria-hidden="true"></div>
  <div class="modal" ng-if="vm.modal.editInvoice.show" role="dialog" aria-modal="true" aria-labelledby="editInvoiceTitle">
    <div class="modal-header">
      <h3 id="editInvoiceTitle">‚úèÔ∏è S·ª≠a h√≥a ƒë∆°n</h3>
      <button class="icon-btn" type="button" aria-label="ƒê√≥ng" ng-click="vm.closeModals()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <label class="form-row">
        <span>M√£ Hƒê</span>
        <input class="input" ng-model="vm.modal.editInvoice.data.id" disabled>
      </label>
      <label class="form-row">
        <span>Kh√°ch h√†ng (maKH)</span>
        <input class="input" ng-model="vm.modal.editInvoice.data.maKH">
      </label>
      <label class="form-row">
        <span>Ghi ch√∫</span>
        <input class="input" ng-model="vm.modal.editInvoice.data.ghiChu">
      </label>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" type="button" ng-click="vm.closeModals()">H·ªßy</button>
      <button class="btn" type="button" ng-click="vm.saveInvoice()" ng-disabled="vm.loading">L∆∞u</button>
    </div>
  </div>

  <!-- MODAL: S·ª≠a chi ti·∫øt -->
  <div class="modal-backdrop" ng-if="vm.modal.editDetail.show" ng-click="vm.closeModals()" aria-hidden="true"></div>
  <div class="modal" ng-if="vm.modal.editDetail.show" role="dialog" aria-modal="true" aria-labelledby="editDetailTitle">
    <div class="modal-header">
      <h3 id="editDetailTitle">‚úèÔ∏è S·ª≠a chi ti·∫øt</h3>
      <button class="icon-btn" type="button" aria-label="ƒê√≥ng" ng-click="vm.closeModals()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <label class="form-row">
        <span>M√£ Hƒê</span>
        <input class="input" ng-model="vm.modal.editDetail.data.maHoaDon" disabled>
      </label>
      <label class="form-row">
        <span>M√£ SP</span>
        <input class="input" ng-model="vm.modal.editDetail.data.maSP">
      </label>
      <label class="form-row">
        <span>S·ªë l∆∞·ª£ng</span>
        <input class="input" type="number" ng-model="vm.modal.editDetail.data.soLuong">
      </label>
      <label class="form-row">
        <span>ƒê∆°n gi√°</span>
        <input class="input" type="number" ng-model="vm.modal.editDetail.data.donGia">
      </label>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" type="button" ng-click="vm.closeModals()">H·ªßy</button>
      <button class="btn" type="button" ng-click="vm.saveDetail()" ng-disabled="vm.loading">L∆∞u</button>
    </div>
  </div>

  <!-- MODAL: S·ª≠a / Th√™m thanh to√°n -->
  <div class="modal-backdrop" ng-if="vm.modal.editPayment.show" ng-click="vm.closeModals()" aria-hidden="true"></div>
  <div class="modal" ng-if="vm.modal.editPayment.show" role="dialog" aria-modal="true" aria-labelledby="editPaymentTitle">
    <div class="modal-header">
      <h3 id="editPaymentTitle">{{ vm.modal.editPayment.isNew ? '‚ûï Th√™m thanh to√°n' : '‚úèÔ∏è S·ª≠a thanh to√°n' }}</h3>
      <button class="icon-btn" type="button" aria-label="ƒê√≥ng" ng-click="vm.closeModals()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-row" ng-if="!vm.modal.editPayment.isNew">
        <label>M√£ TT</label>
        <input class="input" ng-model="vm.modal.editPayment.data.id" disabled>
      </div>
      <label class="form-row">
        <span>M√£ Hƒê</span>
        <input class="input" ng-model="vm.modal.editPayment.data.maHoaDon" disabled>
      </label>
      <label class="form-row">
        <span>S·ªë ti·ªÅn</span>
        <input class="input" type="number" ng-model="vm.modal.editPayment.data.soTien">
      </label>
      <label class="form-row">
        <span>Ph∆∞∆°ng th·ª©c</span>
        <select class="input" ng-model="vm.modal.editPayment.data.phuongThuc">
          <option>Ti·ªÅn m·∫∑t</option>
          <option>Chuy·ªÉn kho·∫£n</option>
          <option>Th·∫ª</option>
        </select>
      </label>
      <label class="form-row">
        <span>Ghi ch√∫</span>
        <input class="input" ng-model="vm.modal.editPayment.data.ghiChu">
      </label>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" type="button" ng-click="vm.closeModals()">H·ªßy</button>
      <button class="btn" type="button" ng-click="vm.savePayment()" ng-disabled="vm.loading">
        {{ vm.modal.editPayment.isNew ? 'Th√™m' : 'L∆∞u' }}
      </button>
    </div>
  </div>
</body>
</html>
