<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Quáº£n lÃ½ cÃ´ng ná»£ - POS & Inventory</title>
    <script src="../script/auth.js"></script>
    <script src="../script/login.js"></script>
    <link rel="stylesheet" href="../style/QuanLyCongNo.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  </head>
  <body>
    <div class="wrap">
      <aside class="sidebar">
        <div class="brand">
          <div class="logo">DAH</div>
          <div><div>Quáº£n lÃ½ bÃ¡n láº» vÃ  kho DAH</div></div>
        </div>

        <div class="nav">
          <div class="section-title">ADMIN</div>
          <a href="QuanLyTaiKhoan.html">ğŸ› ï¸ Quáº£n lÃ½ tÃ i khoáº£n</a>
          <a href="QuanLyNhanVien.html">ğŸ§‘â€ğŸ’¼ Quáº£n lÃ½ nhÃ¢n viÃªn</a>
          <a href="QuanLyKhuyenMai.html">ğŸ Quáº£n lÃ½ khuyáº¿n mÃ£i</a>

          <div class="section-title" style="margin-top:20px;font-weight:700;">Káº¿ toÃ¡n</div>
          <a href="../pages/QuanLyConNo.html">ğŸ§¾ Quáº£n lÃ½ cÃ´ng ná»£</a>
          <a href="../pages/BaoCaoThongKe.html">ğŸ“Š BÃ¡o cÃ¡o thá»‘ng kÃª</a>

          <div class="section-title">THU NGÃ‚N</div>
          <a href="QuanLyBanHang.html">ğŸ§¾ QUáº¢N LÃ BÃN HÃ€NG</a>
          <a href="XuLyDoiTra.html">ğŸ” Xá»¬ LÃ Äá»”I TRáº¢</a>

          <div class="section-title" style="margin-top:20px;font-weight:700;">Thá»§ kho</div>
          <a href="QuanLyDanhMuc.html">ğŸ“¦ Quáº£n lÃ½ Danh má»¥c</a>
          <a href="QuanLySanPham.html">ğŸ“¦ Quáº£n lÃ½ Sáº£n pháº©m</a>
          <a href="QuanLyNhapKho.html">ğŸ“¦Quáº£n lÃ½ Nháº­p kho</a>
          <a href="QuanLyTonKho.html">ğŸ“¦Quáº£n lÃ½ Tá»“n kho</a>

          <div class="section-title">TÃ i khoáº£n</div>
          <div class="quick-stats">
            <div class="row" style="justify-content:space-between"><span>NgÆ°á»i dÃ¹ng:</span><strong>DAH</strong></div>
          </div>
        </div>

        <div class="small muted">Â© DAH</div>
        <div class="logout">
          <a href="index.html">ÄÄƒng xuáº¥t <i class="fa-solid fa-right-from-bracket"></i></a>
        </div>
      </aside>

      <main class="main">
        <div class="header">
          <div>
            <div class="breadcrumbs">Káº¿ toÃ¡n / Quáº£n lÃ½ cÃ´ng ná»£</div>
            <h1 style="margin:6px 0 0 0">Quáº£n lÃ½ cÃ´ng ná»£</h1>
          </div>
        </div>

        <section class="card" aria-label="Danh sÃ¡ch cÃ´ng ná»£ khÃ¡ch hÃ ng">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
            <h2 style="margin:0">KhÃ¡ch hÃ ng cÃ²n ná»£</h2>
          </div>

          <table class="debt-table" id="debt-table">
            <thead>
              <tr>
                <th>KhÃ¡ch hÃ ng</th>
                <th>Sá»‘ hÃ³a Ä‘Æ¡n</th>
                <th>Tá»•ng ná»£ (â‚«)</th>
                <th>CÃ²n ná»£ (â‚«)</th>
                <th>HÃ nh Ä‘á»™ng</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div id="detail-area"></div>
        </section>
      </main>
    </div>

    <script>
      const db = {
        HoaDonBan: [
          { id: 'HD001', ngay: '2025-10-01', khach: 'Nguyá»…n A', tong: 1500000, paid: 500000 },
          { id: 'HD002', ngay: '2025-10-05', khach: 'Äá»— B', tong: 3200000, paid: 3200000 },
          { id: 'HD003', ngay: '2025-10-15', khach: 'Nguyá»…n A', tong: 700000, paid: 0 },
          { id: 'HD004', ngay: '2025-10-20', khach: 'Pháº¡m C', tong: 1200000, paid: 200000 }
        ],
        ThanhToan: [
          { id: 'TT001', hoaDonId: 'HD001', ngay: '2025-10-02', soTien: 500000, method: 'Tiá»n máº·t' },
          { id: 'TT002', hoaDonId: 'HD002', ngay: '2025-10-06', soTien: 3200000, method: 'Chuyá»ƒn khoáº£n' }
        ]
      };

      const money = n => new Intl.NumberFormat('vi-VN').format(n || 0);

      function groupDebts() {
        const map = {};
        db.HoaDonBan.forEach(h => {
          const owe = Math.max(0, (h.tong || 0) - (h.paid || 0));
          if (!map[h.khach]) map[h.khach] = { khach: h.khach, invoices: [], total: 0, owed: 0 };
          map[h.khach].invoices.push(Object.assign({}, h, { owed: owe }));
          map[h.khach].total += (h.tong || 0);
          map[h.khach].owed += owe;
        });
        return Object.values(map).sort((a,b)=>b.owed - a.owed);
      }

      function renderDebts() {
        const tbody = document.querySelector('#debt-table tbody');
        const list = groupDebts();
        if (!list.length) {
          tbody.innerHTML = '<tr><td colspan="5" class="muted">KhÃ´ng cÃ³ khÃ¡ch hÃ ng cÃ²n ná»£.</td></tr>';
          return;
        }
        tbody.innerHTML = '';
        list.forEach((c) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.khach}</td>
            <td>${c.invoices.length}</td>
            <td>${money(c.total)}</td>
            <td>${money(c.owed)}</td>
            <td class="inline">
              <button class="btn ghost" data-act="view" data-k="${c.khach}">Xem hÃ³a Ä‘Æ¡n</button>
              ${c.owed > 0 ? `<button class="btn primary" data-act="pay" data-k="${c.khach}">Thanh toÃ¡n</button>` : `<span class="small muted">ÄÃ£ thu sáº¡ch</span>`}
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      function renderInvoicesFor(khach) {
        const invoices = db.HoaDonBan.filter(h => h.khach === khach);
        if (!invoices.length) {
          document.getElementById('detail-area').innerHTML = '<div class="muted">KhÃ´ng tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n.</div>';
          return;
        }
        let html = `<div class="invoices"><h3 style="margin:8px 0 6px 0">HÃ³a Ä‘Æ¡n cá»§a ${khach}</h3><table class="debt-table"><thead><tr><th>ID</th><th>NgÃ y</th><th>Tá»•ng (â‚«)</th><th>ÄÃ£ tráº£ (â‚«)</th><th>CÃ²n láº¡i (â‚«)</th><th>HÃ nh Ä‘á»™ng</th></tr></thead><tbody>`;
        invoices.forEach(h => {
          const owed = Math.max(0, (h.tong||0) - (h.paid||0));
          html += `<tr>
            <td>${h.id}</td>
            <td>${h.ngay}</td>
            <td>${money(h.tong)}</td>
            <td>${money(h.paid || 0)}</td>
            <td class="${owed ? 'unpaid' : 'paid'}">${money(owed)}</td>
            <td>
              ${owed > 0 
                ? `<button class="btn primary" data-pay="${h.id}">Thanh toÃ¡n</button>`
                : `<span class="small muted">ÄÃ£ thanh toÃ¡n</span>
                   <button class="btn ghost" data-del="${h.id}" style="margin-left:6px;">XÃ³a</button>`}
            </td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
        document.getElementById('detail-area').innerHTML = html;

        document.querySelectorAll('[data-pay]').forEach(b=>{
          b.addEventListener('click', () => payInvoice(b.getAttribute('data-pay')));
        });
        document.querySelectorAll('[data-del]').forEach(b=>{
          b.addEventListener('click', () => deleteInvoice(b.getAttribute('data-del')));
        });
      }

      function payInvoice(invoiceId) {
        const inv = db.HoaDonBan.find(h => h.id === invoiceId);
        if (!inv) return alert('HÃ³a Ä‘Æ¡n khÃ´ng tÃ¬m tháº¥y');
        const owed = Math.max(0, (inv.tong||0) - (inv.paid||0));
        const str = prompt(`HÃ³a Ä‘Æ¡n ${inv.id} cÃ²n ${money(owed)}. Nháº­p sá»‘ tiá»n thanh toÃ¡n (bá» trá»‘ng = toÃ n bá»™):`);
        if (str === null) return;
        let amt = Number(String(str).replace(/[^\d.-]/g,'')) || 0;
        if (amt <= 0) amt = owed;
        if (amt > owed) amt = owed;
        const method = prompt('PhÆ°Æ¡ng thá»©c thanh toÃ¡n (Tiá»n máº·t / Chuyá»ƒn khoáº£n / Tháº»):', 'Tiá»n máº·t') || 'Tiá»n máº·t';
        const ttId = 'TT' + Math.floor(Math.random()*900000 + 100000);
        db.ThanhToan.push({ id: ttId, hoaDonId: inv.id, ngay: new Date().toISOString().slice(0,10), soTien: amt, method });
        inv.paid = (inv.paid || 0) + amt;
        if (inv.paid > inv.tong) inv.paid = inv.tong;
        alert(`Thanh toÃ¡n ${money(amt)} cho ${inv.id} thÃ nh cÃ´ng.`);
        renderDebts();
        renderInvoicesFor(inv.khach);
        document.getElementById('detail-area').scrollIntoView({behavior:'smooth'});
      }

      function deleteInvoice(invoiceId) {
        if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a hÃ³a Ä‘Æ¡n nÃ y khÃ´ng?')) return;
        const idx = db.HoaDonBan.findIndex(h => h.id === invoiceId);
        if (idx === -1) return alert('KhÃ´ng tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n cáº§n xÃ³a.');
        const kh = db.HoaDonBan[idx].khach;
        db.HoaDonBan.splice(idx, 1);
        alert('ÄÃ£ xÃ³a hÃ³a Ä‘Æ¡n ' + invoiceId);
        renderDebts();
        renderInvoicesFor(kh);
      }

      document.addEventListener('DOMContentLoaded', () => {
        renderDebts();
        document.getElementById('debt-table').addEventListener('click', e => {
          const v = e.target;
          if (v.matches('[data-act="view"]')) {
            renderInvoicesFor(v.getAttribute('data-k'));
            document.getElementById('detail-area').scrollIntoView({behavior:'smooth'});
          } else if (v.matches('[data-act="pay"]')) {
            renderInvoicesFor(v.getAttribute('data-k'));
            document.getElementById('detail-area').scrollIntoView({behavior:'smooth'});
          }
        });
      });
    </script>
  </body>
</html>